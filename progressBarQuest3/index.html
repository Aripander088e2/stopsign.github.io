<!DOCTYPE html>
<html class='objectContainer'>
    <head>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <title>Progress Bars</title>
        <link rel="stylesheet" href="stylesheets/stylesheet.css">

        <script src="libraries/angular.min.js"></script>
        <script src="classes/progressBar.js"></script>
        <script src="classes/globalButtons.js"></script>
        <script src="classes/helpers.js"></script>
    </head>
    <body data-ng-app="myApp" ng-controller="myCtrl" class='objectContainer' style='text-align:center;position:absolute;background-color:#c1d7ee'>
        <div data-ng-click="hasProgressMovement = (!hasProgressMovement)" class='hyperVisible quickButton ' style='width:117px;'>Toggle Progress Movement Visibility</div>
        <div data-ng-click="toggleStartStop()" class='hyperVisible quickButton '>Toggle Start / Stop</div>
        <div data-ng-click="toggleNextColor()" class='hyperVisible quickButton '>Toggle Next Color</div>
        <div data-ng-click="isRowsVisible = (!isRowsVisible)" class='hyperVisible quickButton' style="width:91px;">Toggle Progress Visible</div>
        <!--<div ng-click="" class='hyperVisible quickButton'>Toggle Row Visible</div>
        <div ng-click="" class='hyperVisible quickButton'>Toggle Exp Visible</div>-->
        <div data-ng-click="toggledBarsLeft=!toggledBarsLeft" class='hyperVisible quickButton'>Toggle Bar Direction</div>
        <div id='fps' style='float:left;font-size:14px;background-color:grey;width:60px;padding:3px;border-radius:5px;'>{{fps}} fps</div>
        
        <div id='progressBars' style='margin-top:10px;display:block;width:50%' ng-show="isRowsVisible" class='objectContainer'></div>
        <div id='buttons' class='objectContainer'></div>

        <div style='width:100%;font-size: 16px;margin-top:10px;text-align:center;'>To mass-buy, click a button then hold Enter</div>
        <div style='text-align:left;font-size:12px;width:100%;margin-top:30px;margin-left:10px;margin-bottom:10px;color:grey'>If you want patterns, not gameplay (won't be in final version):</div>
        <div data-ng-click="testSettings()" style='float:left;width:75px' class='hyperVisible quickButton '>+1k</div>
        <div data-ng-click="testSettings2()" style='float:left;width:75px' class='hyperVisible quickButton '>+50k </div>
    </body>
</html>

<script>
//the answer to "how to i access scope variables from console"
//angular.element($0).scope()

/* TODO: 
speed to the left
level inside 
produces currencies[row]
spawns with a buy button on row+1 (further down) that costs  5 * Math.pow(3, (length - row)) of currencies[row], and gives +1 to expGain of row+1

upgrades come from the rows 3 rows up, where a x2 to 7 is available for 10k of rows 4 and 1
each row gains expGain into Level
Level up gives 10% higher expGain bonus
levelUp needs 10 exp to start, 
*/


var multFromFps = 1;
var initialRowCount = 4;
var msWaitTime = 33;

var app = angular.module('myApp', []);
app.controller('myCtrl', function($scope, $interval, $compile) {

    $scope.pbars = [];
    var timeList = [];
    var timer = 0;
    var timeUntilNextBar = -500; //so that it makes the first row immediately
    var stop = 0;
    $scope.hasProgressMovement = 1;
    $scope.isRowsVisible = 1;

    //not public-facing game vars
    var initialProgressRate = .025;
    var regularRowHue = 180;

    //ang both game & graphics vars
    $scope.boughtSpeedBonus =0;
    $scope.secondsBoost = 1;
    $scope.theResource = 0;
    $scope.gainFirst = 20;
    $scope.gainAll = 1;

    $scope.costSpeedBonus = 500;
    $scope.costSecondsBoost = 30;
    $scope.costBuyRow = 25;
    $scope.costGainFirst = 8;
    $scope.costGainAll = 150;

    $scope.tick = function() {
        if(stop) {
            return;
        }
        timer++;
        timeList.push(new Date().getTime());
        if(timeList.length > 100) {
            timeList.splice(0, 1);
            var fps = msWaitTime/((timeList[timeList.length-1] - timeList[0]) / (timeList.length-1))*100;
            multFromFps = 100/fps;
            $scope.fps = round(fps)+"%";
        } else {
            multFromFps = 1;
            $scope.fps = "...";
        }

        $scope.updateProgressForAllRows();

        //manual addition to give starting rows
        if($scope.pbars.length < initialRowCount && timer - timeUntilNextBar >= 25) {
            if($scope.pbars.length === 0) {
                $scope.addProgressBar("first");
            } else {
                $scope.addProgressBar("regular");
            }
            timeUntilNextBar = timer
        }
    };

    var buttons = new GlobalButtons($scope);
    $scope.buySpeedBonus = buttons.buySpeedBonus;
    $scope.buySecondsBoost = buttons.buySecondsBoost;
    $scope.buyProgressBar = buttons.buyProgressBar;
    $scope.buyGainFirst = buttons.buyGainFirst;
    $scope.buyGainAll = buttons.buyGainAll;

    $scope.testSettings = buttons.testSettings;
    $scope.testSettings2 = buttons.testSettings2;


    {//-------------Application Functions-------------- updateProgressForAllRows, updateRowProgress, addProgressBar, addProgressBarData

        $scope.updateProgressForAllRows = function() {
            for(var lx = 0; lx < $scope.pbars.length ; lx++) {
                $scope.updateRowProgress(lx)
            }
        };
        
        $scope.updateRowProgress = function(row) { //main game progress
            $scope.pbars[row].nextProgressDown((1+$scope.boughtSpeedBonus/100), function() { 
                var lastIndex = $scope.pbars.length-1;
                //$scope.theResource += $scope.gainAll *Math.pow(10, $scope.pbars[row].speedReduceMult-1)
                
                $scope.pbars[row].nextExp($scope.secondsBoost);
                var resourceGain = $scope.pbars[row].resGain * Math.pow(10, $scope.pbars[row].speedReduceMult-1);
                $scope.pbars[row].resources += resourceGain;
                if(row < lastIndex) { //all but the bottom-most row
                    $scope.pbars[lastIndex].resources += resourceGain;
                    $scope.pbars[row+1].speedGainOpacity = 1;
                    $scope.pbars[row+1].speedGain = round1((1+($scope.pbars[row].level-1)*.1)*Math.pow(10, $scope.pbars[row].speedReduceMult-1));
                    $scope.pbars[row+1].speedMult = round1($scope.pbars[row+1].speedGain + $scope.pbars[row+1].speedMult);
                }
            });
        };
        
        $scope.addProgressBar = function(type) { //add progress bar (both data and UI)
            $scope.addProgressBarData(type);
            $scope.addProgressBarUI();
        }
    
    }



    {//--------------Graphics Functions--------------- addProgressBarUI, addBuyButtonTemplate,
        $scope.addProgressBarUI = function() {
            
            var curRowCount = $scope.pbars.length;
            //$scope.expToNextLevel
            var progressPrc = "{{ !hasProgressMovement ? 75 : "+ //force to 100
            "(toggledBarsLeft ? "+
            "pbars["+(curRowCount-1)+"].progress/pbars["+(curRowCount-1)+"].progressReq * 100  :" + //go left
            "100 - (pbars["+(curRowCount-1)+"].progress/pbars["+(curRowCount-1)+"].progressReq * 100))" //go right
            +"}}";

            var newDirective = angular.element(
                "<div class='progressOuter' ng-class="+'"'+"{ 'leveling' : pbars["+(curRowCount-1)+"].isLeveling }"+'"'+">"+
                    "<div id='progressInner"+(curRowCount-1)+"' class='progressInner'"+
                        " style='width:"+progressPrc+"%;background-color:{{pbars["+(curRowCount-1)+"].color}};'>"+
                    "</div>"+
                    "<div class='exp hyperVisible'><div class='level'>Level {{pbars["+(curRowCount-1)+"].level}}</div>{{pbars["+(curRowCount-1)+"].exp+" +
                    "'  / '+pbars["+(curRowCount-1)+"].expToNextLevel}} exp</div>"+
                    "<div class='hyperVisible speedMult'>{{pbars["+(curRowCount-1)+"].speedMult}}%</div>"+
                    "<div class='hyperVisible speedGain' style='opacity:{{pbars["+(curRowCount-1)+"].speedGainOpacity}}'>+{{pbars["+(curRowCount-1)+"].speedGain}}</div>"+
                    "<div class='hyperVisible resources' style='color:" + getResourceColor(curRowCount-1) + "'>" +
                        "Resource {{pbars["+(curRowCount-1)+"].row+1}} = {{pbars["+(curRowCount-1)+"].resources}}" +
                        ", Gain = {{pbars["+(curRowCount-1)+"].resGain}}" +
                    "</div>"+
                "</div>"
            );
            var progressBarContainer = document.getElementById('progressBars');
            angular.element(progressBarContainer).append(newDirective);
            $compile(newDirective)($scope);
        };
        
        /*Parameters:
        @buttonText - the text to appear on the button
        @topNumVarName - the number displayed at the top of the button container
        @topNumColor - the color of displayed topNumVar
        @onClickFunctionName - the name of the function to put in the ng-click. "hello" becomes ng-click="hello()"
        @costVarName - the name of the cost amount variable
        @botNumColor - the color of displayed costVar
        */
        $scope.addBuyButtonTemplate = function(buttonText, topNumVarName, 
            topNumColor, onClickFunctionName, costVarName, botNumColor) {
            
            //make an element
            var newDirective = angular.element(
            "<div class='buttonContainer'>"+
                "<div class='resource hyperVisible' style='color:"+topNumColor+"'>{{"+topNumVarName+"}}</div>"+
                "<button class='buyButton' data-ng-click='"+onClickFunctionName+"()'>"+buttonText+"</button>"+
                "<div class='middleLabel'>It costs <div class='countCost hyperVisible' style='color:"+botNumColor+"'>{{"+costVarName+"}}</div></div>"+
            "</div>"
            );
            var buttonsContainer = document.getElementById('buttons');
            angular.element(buttonsContainer).append(newDirective);
            $compile(newDirective)($scope); //re-compile (so it picks up the angular vars)
        };
        
        $scope.toggleNextColor = function() {
            regularRowHue -= 18;
            for(var lx = 0; lx < $scope.pbars.length; lx++) {
                $scope.pbars[lx].initialColorHue = regularRowHue;
                $scope.pbars[lx].color = colorShiftMath(regularRowHue, 0, 0);
            }
        };
        
        function getResourceColor(resNum) {
            return colorShiftMath(regularRowHue, resNum*4, 0);
        }
    }
    
    
    {//----------Initial Button & Row Load------------
        //This stuff really belongs in a database
        //function calls are required to be after variable declarations
        $scope.addBuyButtonTemplate("% Global Speed Increase", "boughtSpeedBonus", "blue", "buySpeedBonus", "costSpeedBonus", "red");
        $scope.addBuyButtonTemplate("Seconds of Boost on Level Up", "secondsBoost", "blue","buySecondsBoost", "costSecondsBoost", "red");
        $scope.addBuyButtonTemplate("Buy 2 Progress Bars", "pbars[pbars.length-1].resources", "red", "buyProgressBar", "costBuyRow", "red");
        $scope.addBuyButtonTemplate("Gain for Last", "pbars[pbars.length-1].resGain", "blue", "buyGainFirst", "costGainFirst", "red");
        $scope.addBuyButtonTemplate("Gain for All", "gainAll", "blue", "buyGainAll", "costGainAll", "red");
    
    
        $scope.addProgressBarData = function(type) { 
            //progressBar (initialProgressReq, initialProgressRate, initialProgress, isExpGainOn, boostLimitInTicks, initialColorHue, gainAmount, row) {
            var progressCreationLength = 20; //* Math.pow(1.01, $scope.pbars.length)
            if(type === "first") {
                $scope.pbars.push(new ProgressBar (progressCreationLength, initialProgressRate, progressCreationLength/2, 6*(1000/ msWaitTime), regularRowHue, 20, $scope.pbars.length))
            } else if(type === "regular") {
                $scope.pbars.unshift(new ProgressBar (progressCreationLength, initialProgressRate, progressCreationLength, 6*(1000/ msWaitTime), regularRowHue, $scope.gainAll, $scope.pbars.length))
            }
        }
    }


    $scope.toggleStartStop = function() {
        stop = !stop;
        timeList = [];
    };



    var doWork = new Worker('interval.js');
    doWork.onmessage = function(event) {
        if ( event.data === 'interval.start' ) {
            $scope.$apply($scope.tick());
        }
    };
    doWork.postMessage({start:true, ms:msWaitTime});
    //$interval(function() { if(!stop) $scope.tick(); }, msWaitTime);
});

</script>